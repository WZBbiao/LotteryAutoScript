# B站抽奖脚本 - 服务器部署方案指南

## 📋 方案对比

| 方案 | 费用 | 难度 | 稳定性 | 推荐度 |
|-----|------|------|--------|--------|
| GitHub Actions | 免费 | ⭐ | ⭐⭐⭐⭐⭐ | 🥇 最推荐 |
| 青龙面板 | 免费 | ⭐⭐ | ⭐⭐⭐⭐ | 🥈 推荐 |
| 云服务器 | 付费 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 🥉 适合高级用户 |
| LeanCloud | 免费 | ⭐⭐ | ⭐⭐ | ❌ 不推荐 |

---

## 🥇 方案一：GitHub Actions（免费 + 最简单）

### 优点
- ✅ 完全免费
- ✅ 无需服务器
- ✅ 自动定时运行
- ✅ 配置简单
- ✅ 运行稳定

### 步骤

#### 1. Fork 项目到你的 GitHub

访问：https://github.com/shanmiteko/LotteryAutoScript
点击右上角 `Fork` 按钮

#### 2. 配置 GitHub Secrets

进入你 Fork 的仓库，点击：
```
Settings → Secrets and variables → Actions → New repository secret
```

添加以下 Secrets：

| Name | Value | 说明 |
|------|-------|------|
| `COOKIE` | 你的B站Cookie | 必填 |
| `FEISHU_WEBHOOK` | 飞书Webhook地址 | 可选 |
| `SENDKEY` | Server酱Key | 可选 |
| `TG_BOT_TOKEN` | Telegram Bot Token | 可选 |
| `TG_USER_ID` | Telegram User ID | 可选 |

#### 3. 创建 GitHub Actions 工作流

在你的仓库中创建文件：`.github/workflows/lottery.yml`

```yaml
name: B站抽奖

on:
  schedule:
    # 每天 UTC 0:00 运行（北京时间 8:00）
    - cron: '0 0 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  lottery:
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v3

    - name: 设置 Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: 安装依赖
      run: npm install

    - name: 配置环境变量
      run: |
        cat > env.js << 'EOF'
        module.exports = Object.freeze({
            account_parm: {
                COOKIE: process.env.COOKIE || '',
                NOTE: '账号1',
                NUMBER: 1,
                CLEAR: true,
                ACCOUNT_UA: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                ENABLE_CHAT_CAPTCHA_OCR: false,
                CHAT_CAPTCHA_OCR_URL: '',
                ENABLE_AI_COMMENTS: false,
                ENABLE_MULTIPLE_ACCOUNT: false,
                MULTIPLE_ACCOUNT_PARM: '',
                LOTTERY_LOG_LEVEL: 3,
                NOT_GO_LOTTERY: ''
            },
            multiple_account_parm: [],
            push_parm: {
                SCKEY: '',
                SENDKEY: process.env.SENDKEY || '',
                QQ_SKEY: '',
                QQ_MODE: '',
                BARK_PUSH: '',
                BARK_SOUND: '',
                PUSHDEER_URL: '',
                PUSHDEER_PUSHKEY: '',
                TG_BOT_TOKEN: process.env.TG_BOT_TOKEN || '',
                TG_USER_ID: process.env.TG_USER_ID || '',
                TG_PROXY_HOST: '',
                TG_PROXY_PORT: '',
                DD_BOT_TOKEN: '',
                DD_BOT_SECRET: '',
                QYWX_AM: '',
                QYWX_KEY: '',
                IGOT_PUSH_KEY: '',
                PUSH_PLUS_TOKEN: '',
                PUSH_PLUS_USER: '',
                QMSG_KEY: '',
                QMSG_QQ: '',
                SMTP_HOST: '',
                SMTP_PORT: '',
                SMTP_USER: '',
                SMTP_PASS: '',
                SMTP_TO_USER: '',
                GOTIFY_URL: '',
                GOTIFY_APPKEY: '',
                FEISHU_WEBHOOK: process.env.FEISHU_WEBHOOK || ''
            },
            ai_parm: {
                AI_API_KEY: process.env.AI_API_KEY || '',
            }
        });
        EOF

        cp my_config.example.js my_config.js
      env:
        COOKIE: ${{ secrets.COOKIE }}
        FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        SENDKEY: ${{ secrets.SENDKEY }}
        TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
        TG_USER_ID: ${{ secrets.TG_USER_ID }}

    - name: 运行抽奖脚本
      run: npm run start
      env:
        COOKIE: ${{ secrets.COOKIE }}
        FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        SENDKEY: ${{ secrets.SENDKEY }}
        TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
        TG_USER_ID: ${{ secrets.TG_USER_ID }}

    - name: 检查中奖
      run: npm run check
      env:
        COOKIE: ${{ secrets.COOKIE }}
        FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
```

#### 4. 启用 Actions

- 进入仓库的 `Actions` 标签
- 点击 `I understand my workflows, go ahead and enable them`
- 可以手动点击 `Run workflow` 测试

#### 5. 定时设置说明

Cron 表达式说明（UTC时间）：
```
'0 0 * * *'   # 每天 0:00 UTC（北京时间 8:00）
'0 8 * * *'   # 每天 8:00 UTC（北京时间 16:00）
'0 */6 * * *' # 每 6 小时运行一次
'0 0,12 * * *' # 每天 0:00 和 12:00 运行
```

---

## 🥈 方案二：青龙面板（需要服务器）

### 优点
- ✅ 功能强大
- ✅ 界面友好
- ✅ 支持多脚本管理
- ✅ 支持定时任务

### 前提条件
需要一台服务器（国内VPS、阿里云、腾讯云等）

### 快速部署

#### 1. 安装 Docker

```bash
# CentOS/RHEL
curl -fsSL https://get.docker.com | bash -s docker

# Ubuntu/Debian
curl -fsSL https://get.docker.com | bash -s docker
```

#### 2. 安装青龙面板

```bash
docker run -dit \
  -v $PWD/ql:/ql/data \
  -p 5700:5700 \
  --name qinglong \
  --hostname qinglong \
  --restart unless-stopped \
  whyour/qinglong:latest
```

#### 3. 访问青龙面板

浏览器访问：`http://你的服务器IP:5700`

初次访问会要求设置管理员账号密码

#### 4. 添加脚本

参考项目中的文档：[doc/run_use_ql.md](doc/run_use_ql.md)

1. 复制初始化脚本：[script/qinglong/init.sh](script/qinglong/init.sh)
2. 在青龙面板中粘贴运行
3. 配置 Cookie 和推送参数
4. 设置定时任务

---

## 🥉 方案三：云服务器直接部署

### 适合场景
- 需要完全控制
- 有其他服务需要部署
- 对稳定性要求极高

### 推荐服务商

#### 国内
- **腾讯云轻量应用服务器**：￥50-100/年
- **阿里云ECS**：￥99-200/年
- **华为云**：经常有优惠活动

#### 国外
- **AWS Free Tier**：免费1年
- **Oracle Cloud**：永久免费ARM实例
- **Google Cloud**：$300免费额度

### 部署步骤

#### 1. SSH 连接服务器

```bash
ssh root@你的服务器IP
```

#### 2. 安装 Node.js

```bash
# 使用 nvm 安装
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
```

#### 3. 克隆项目

```bash
cd ~
git clone https://github.com/shanmiteko/LotteryAutoScript.git
cd LotteryAutoScript
npm install
```

#### 4. 配置文件

```bash
cp env.example.js env.js
cp my_config.example.js my_config.js

# 编辑配置
vim env.js
vim my_config.js
```

#### 5. 设置定时任务

```bash
crontab -e
```

添加以下内容：

```cron
# 每天早上8点运行抽奖
0 8 * * * cd ~/LotteryAutoScript && node main.js start >> ~/lottery.log 2>&1

# 每天晚上8点检查中奖
0 20 * * * cd ~/LotteryAutoScript && node main.js check >> ~/lottery.log 2>&1

# 每周日凌晨2点清理动态
0 2 * * 0 cd ~/LotteryAutoScript && node main.js clear >> ~/lottery.log 2>&1
```

#### 6. 使用 PM2 保持运行（可选）

```bash
# 安装 PM2
npm install -g pm2

# 启动脚本
pm2 start main.js --name lottery -- start

# 设置开机自启
pm2 startup
pm2 save

# 查看日志
pm2 logs lottery
```

---

## ❌ 不推荐方案：LeanCloud

### 为什么不推荐

1. **云函数超时限制** - 仅15秒，抽奖脚本会超时
2. **免费版休眠** - 运行18小时后休眠，需要外部唤醒
3. **流控限制** - 频繁访问会被限流
4. **不适合长时间任务** - 云函数设计用于短时间请求响应

### 如果一定要用 LeanCloud

需要额外使用腾讯云函数或其他服务来定时唤醒，配置复杂且不稳定。

---

## 📊 推荐选择

| 你的情况 | 推荐方案 |
|---------|---------|
| 想要免费、简单 | **GitHub Actions** 🥇 |
| 有多个脚本要管理 | **青龙面板** 🥈 |
| 需要完全控制 | **云服务器** 🥉 |
| 预算有限 | **GitHub Actions** 或 **Oracle Cloud 永久免费** |
| 对稳定性要求高 | **付费云服务器** |

---

## 🎯 我的建议

**对于你的情况（Mac本地，想要持续运行）：**

1. **首选 GitHub Actions**
   - 无需服务器
   - 完全免费
   - 配置10分钟搞定
   - 稳定可靠

2. **备选方案：Oracle Cloud 永久免费服务器**
   - 注册后获得永久免费的 ARM 实例
   - 部署青龙面板或直接运行脚本
   - 适合长期使用

3. **土豪方案：腾讯云轻量服务器**
   - ￥50-100/年
   - 性能更好
   - 延迟更低

---

## 🚀 快速开始（GitHub Actions）

如果你想立即开始，我可以帮你：
1. 创建完整的 GitHub Actions 配置文件
2. 设置好所有环境变量
3. 配置定时运行时间

只需要你：
1. Fork 项目到 GitHub
2. 添加 Secrets
3. 启用 Actions

需要我帮你创建配置文件吗？
